# í¬íŒ… ë§¤ë‰´ì–¼

íƒœê·¸: ìš´ì˜ & ìœ ì§€ë³´ìˆ˜
ìµœê·¼ ìˆ˜ì •ì¼: 2023ë…„ 10ì›” 23ì¼

### 1. ë²„ì „ ì •ë³´

**Cloud Server**   **:  Amazon EC2**

**Web Server     :  Nginx**

**DB Server** 

**- AWS RDS**

### Backend

```json
"Java"            : "OpenJDK 11.0.1"
"Python"          : "3.11+"
"Spring"          : "5.3.29"
"Spring Boot"     : "2.7.15"
"Spring Security" : "5.7.10"
"Gradle"          : "8.1.1"
"FastAPI"         : "0.63.0"
```

- **application.yml**
    
    ```yaml
    #
    ```
    
- **application-db.yml**
    
    ```yaml
    #
    ```
    

<aside>

ğŸš¨ Application ì„¤ì •íŒŒì¼ì€ ```ê³¼ê¸ˆ```ì´ ë  ìˆ˜ ìˆëŠ” ë¯¼ê°ì •ë³´ë“¤ì´ ì¡´ì¬í•˜ë¯€ë¡œ, ```Jenkins``` ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì— í™˜ê²½ì— ë³„ë„ë¡œ ì‘ì„±

</aside>

### Frontend

```json
"React"          : "18.2.0"
"Recoil"         : "0.7.7"
"TypeScript"     : "^18.2.21"
"npm"            : "9.6.7"
"node.js"        : "18.17.0"
"Axios"          : "^1.5.0"
"vite"           : "^4.4.9"
"tailwindcss"    : "^3.3.3"
```

### Database

```json
"MySQL" : "8.0.33"
"Mongo" : "4.6.1"
```

### Infra

```json
"Ubuntu"     : "20.0.4 LTS"
"Jenkins"    : "2.414.1"
"Docker"     : "24.0.6"
"Nginx"      : "1.18.0 (Ubuntu)"
```

### 2. í¬íŠ¸ ì •ë³´

| Port | ìš©ë„ | ê°œë°© |
| --- | --- | --- |
| 22 | SSH | â­• |
| 80 | NGINX | â­• |
| 443 | NGINX | â­• |
| 8888 | Jenkins | â­• |
| 8081, 8082, 8180, 8181 | BE PJT | âŒ |
| 3000, 3001 | FE PJT | âŒ |

### 3. EC2 ì‚¬ì „ ì„¤ì • (Docker Out Of Docker ë°©ì‹ í™œìš©)

```bash
# ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
$ sudo apt-get update

# íŒ¨í‚¤ì§€ ì„¤ì¹˜
$ sudo apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common
# Docker GPG í‚¤ ì¶”ê°€
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
# Docker apt repository ì¶”ê°€
$ sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"

# ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
$ sudo apt-get update
# Docker ì„¤ì¹˜
$ sudo apt-get install docker-ce docker-ce-cli containerd.io

# ê¶Œí•œ ì„¤ì •
cd /var/run
sudo chmod 777 docker.sock
```

**ë°©í™”ë²½**
```bash
// ë°©í™”ë²½ ì„¤ì •
sudo ufw status // Status : inactive

// ufw í™œì„±í™”
sudo ufw enable

// ì‚¬ìš©í•  í¬íŠ¸ í—ˆìš©
sudo ufw allow [í¬íŠ¸ë²ˆí˜¸] 

// ufw ìƒíƒœ ë° ë“±ë¡ëœ rule í™•ì¸
sudo ufw status numbered

// ë“±ë¡í•œ í¬íŠ¸ ì‚­ì œ
sudo ufw delete [ë²ˆí˜¸]
```

**Nginx**

```bash
# Nginx ì„¤ì¹˜
$ sudo apt-get install nginx

# SSL ì¸ì¦ì„ ìœ„í•œ Certbot, LetsEncrypt
$ sudo apt-get install certbot python3-certbot-nginx
$ sudo apt-get install letsencrtypt

# Certbotì„ í†µí•œ SSL ì¸ì¦ì„œ ë°œê¸‰ (ì´ë©”ì¼, ë„ë©”ì¸ í•„ìš”)
$ sudo certbot --nginx
```

```bash
# Nginx ì„¤ì •íŒŒì¼
# /etc/nginx/conf.d/default.conf

limit_req_zone $binary_remote_addr:$uri zone=request_limit_per_ip:10m rate=3r/s;

server {
        server_name cicdtest.store;

        location / {
                proxy_pass http://localhost:3000;
        }

        location /api {
                proxy_pass http://localhost:8081;
                proxy_set_header Connection '';
                proxy_http_version 1.1;
                proxy_read_timeout 86400;
                limit_req zone=request_limit_per_ip burst=5 delay=10;
                limit_req_status 429;
        }

        location /ws {
                proxy_pass http://localhost:8081;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "Upgrade";
                proxy_set_header Host $host;
        }

    listen [::]:443 ssl http2 ipv6only=on;
    listen 443 ssl http2; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/cicdtest.store/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/cicdtest.store/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = cicdtest.store) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    server_name cicdtest.store;
    listen 80;
    return 404; # managed by Certbot
}
```

### Jenkins

```bash
# Jenkins ì´ë¯¸ì§€ PULL
$ sudo docker pull jenkins/jenkins:lts

# Jenkins ì»¨í…Œì´ë„ˆ ì‹¤í–‰
$ sudo docker run -d -u root -it -v /var/run/docker.sock:/var/run/docker.sock -v /lib/modules:/lib/modules -p 8888:8080 --name jenkins jenkins/jenkins:lts
```

```bash
// 1. Jenkins ì»¨í…Œì´ë„ˆ ì ‘ì†
docker exec -it jenkins /bin/bash

// Jenkins ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í•„ìš” íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° ì‚¬ìš©ì ê¶Œí•œ ë¶€ì—¬ (docker cli, vim)
apt-get update

apt-get install docker-cli

# ë§Œì•½ ìœ„ ëª…ë ¹ì–´ì—ì„œ docker-cli íŒ¨í‚¤ì§€ë¥¼ ëª»ì°¾ëŠ” ì—ëŸ¬ê°€ ë‚˜ì˜¨ë‹¤ë©´ .....
# ì´ ì  í‚¨ìŠ¤ ì´ë¯¸ì§€ê°€ ubuntuê°€ ì•„ë‹Œ debian ê¸°ë°˜ ì´ë¯¸ì§€ì¸ë°, 
# debian ê¸°ë°˜ì—ì„œ Dockerì™€ ê´€ë ¨ëœ íŒ¨í‚¤ì§€ì— docker-clië¼ëŠ” ì´ë¦„ì´ ì—†ëŠ” ê²ƒì´ë‹¤.
# ë”°ë¼ì„œ ì•„ë˜ ì„¤ì •ì„ ë”°ë¥¸ë‹¤. 

# ì €ì¥ì†Œ ì •ë³´ ì…ë ¥
# echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian bookworm stable" | tee /etc/apt/sources.list.d/docker.list

# ì €ì¥ì†Œ GPG í‚¤ ë‹¤ìš´ ë° ì‹ ë¢° ëª©ë¡ì— ì¶”ê°€
# curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# ì•„ë˜ ì—…ë°ì´íŠ¸ê°€ ì ìš©ë˜ë©´ Docker ì €ì¥ì†Œê°€ ì‹œìŠ¤í…œì— ì˜¬ë°”ë¥´ê²Œ ì¶”ê°€ ëœ ê²ƒ
# apt-get update

# apt-get install -y docker-ce-cli

# docker ps -aë¡œ ì™¸ë¶€ì—ì„œ ì‹¤í–‰í•œ jenkins ì»¨í…Œì´ë„ˆê°€ jenkins ë‚´ë¶€ì—ì„œë„ ì‹¤í–‰ì¤‘ì¸ì§€ í™•ì¸

apt-get install vim

# usermod -aG docker jenkins

// 2. Jenkins ë¹„ë°€ë²ˆí˜¸ í™•ì¸
cat var/jenkins_home/secrets/initialAdminPassword

// 3. ì›¹ í˜ì´ì§€ì—ì„œ Jenkins ì ‘ì†
ID : admin
PWD : 2ë²ˆì—ì„œ ì–»ì€ ê°’
```

### 4. ë°°í¬

**BackEnd Spring**
```docker
# ë² ì´ìŠ¤ ì´ë¯¸ì§€ë¡œ ë°˜ë“œì‹œ ìµœìƒë‹¨ì— ìœ„ì¹˜í•´ì•¼ í•œë‹¤.
FROM openjdk:11-jdk

# ë³´ì•ˆì„ ìœ„í•´ ì„¤ì •íŒŒì¼ì„ ë³µì‚¬í•˜ëŠ” ê³¼ì •ìœ¼ë¡œ, ì  í‚¨ìŠ¤ì—ì„œ ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì— ì£¼ì„ ì²˜ë¦¬
# COPY usr/spring/resources ./resources

# ì  í‚¨ìŠ¤ê°€ ë¹Œë“œí•œ ë°±ì—”ë“œ í”„ë¡œì íŠ¸ Jar íŒŒì¼ì„ ì»¨í…Œì´ë„ˆ ì™¸ë¶€ì—ì„œ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ë³µì‚¬í•œë‹¤.
COPY build/libs/*.jar application.jar

# ì»¨í…Œì´ë„ˆ ì™¸ë¶€ì—ì„œ ì‚¬ìš©í•  í¬íŠ¸ ë²ˆí˜¸ë¥¼ ì„¤ì •í•œë‹¤.
EXPOSE 8081

# ì´ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë  ê²½ìš° ìˆ˜í–‰í•  ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì§€ì •í•œë‹¤.
ENTRYPOINT ["java","-jar", "-Duser.timezone=Asia/Seoul", "application.jar"]


```

```go
// BE Jenkinsfile
pipeline {
    agent any
    stages {
        stage("Set Variable") {
            steps {
                script {
                    IMAGE_NAME_BE = "cicdtest-back"
                    APPLICATION_YML_PATH = "/usr/spring/resources"
                    CONTAINER_NAME_BE = "cicdtest_back"
                    PROJECT_DIR_BE = "back"
                }
            }
        }

        // ì„¤ì •íŒŒì¼ ì°¸ì¡°
        stage("copy yml") {
            steps {
                sh """
                    if [ ! -d "${PROJECT_DIR_BE}/src/main/resources" ]; then
                        mkdir -p "${PROJECT_DIR_BE}/src/main/resources"
                    fi

                    cp ${APPLICATION_YML_PATH}/* ${PROJECT_DIR_BE}/src/main/resources
                    """
            }
        }

        // ë°±ì—”ë“œ í”„ë¡œì íŠ¸ ë¹Œë“œ
        stage("be build") {
            // build
            steps{
                sh """
                cd ${PROJECT_DIR_BE}
                chmod 777 ./gradlew
                ls -al
                pwd
                ./gradlew clean build
                """
            }
        }

        // ì»¨í…Œì´ë„ˆ í´ë¦¬ë‹
        stage("container cleaning") {
            steps{
                sh "docker ps -q -f name=${CONTAINER_NAME_BE} | xargs --no-run-if-empty docker container stop"
                sh "docker container ls -a -q -f name=${CONTAINER_NAME_BE} | xargs --no-run-if-empty docker rm"
            }
        }

        // ì´ë¯¸ì§€ ì‚­ì œ
        stage("image cleaning") {
            steps{
                sh "docker images ${IMAGE_NAME_BE} -q | xargs -r docker rmi -f"
            }
        }

        // ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
        stage("be image build") {
            steps {
                dir("${PROJECT_DIR_BE}") {
                    script {
                        sh "docker build --no-cache -t ${IMAGE_NAME_BE} ."
                    }
                }
            }
        }

        // ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        stage("be container run") {
            steps {
                script {
                    sh "docker run -d -p 8081:8081 --name ${CONTAINER_NAME_BE} ${IMAGE_NAME_BE} -e TZ=Asia/Seoul"
                }
            }
        }
    }
}

```

**Backend FastAPI**
```docker
FROM python:3.11.4

WORKDIR /data

# ì‹œê°„ ì„¤ì •
RUN ln -snf /usr/share/zoneinfo/Asia/Seoul /etc/localtime

RUN echo Asia/Seoul > /etc/timezone

COPY . .

RUN pip install -r requirements.txt

EXPOSE 8181

ENTRYPOINT ["python","main.py"]
```

```go
// BE Jenkinsfile
pipeline {
    agent any
    stages {
        stage("Set Variable") {
            steps {
                script {
                    IMAGE_NAME_BE = "dailylab-dev-fastapi"
                    CONFIG_PATH = "/usr/fastapi"
                    CONTAINER_NAME_BE = "daily_dev_data"
                    PROJECT_DIR_BE = "data"
                }
            }
        }

        // ì„¤ì •íŒŒì¼ ê°–ê³ ì˜¤ê¸°
        stage("copy config") {
            steps {
                sh "cp ${CONFIG_PATH}/* ${PROJECT_DIR_BE}/"
            }
        }

        // ì»¨í…Œì´ë„ˆ í´ë¦¬ë‹
        stage("container cleaning") {
            steps{
                sh "docker ps -q -f name=${CONTAINER_NAME_BE} | xargs --no-run-if-empty docker container stop"
                sh "docker container ls -a -q -f name=${CONTAINER_NAME_BE} | xargs --no-run-if-empty docker rm"
            }
        }

        // ì´ë¯¸ì§€ ì‚­ì œ
        stage("image cleaning") {
            steps{
                sh "docker images ${IMAGE_NAME_BE} -q | xargs -r docker rmi -f"
            }
        }

        // ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
        stage("be image build") {
            steps {
                dir("${PROJECT_DIR_BE}") {
                    script {
                        sh "docker build --no-cache -t ${IMAGE_NAME_BE} ."
                    }
                }
            }
        }

        // ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        stage("be container run") {
            steps {
                script {
                    sh "docker run -d -p 8181:8181 --name ${CONTAINER_NAME_BE} ${IMAGE_NAME_BE} -e TZ=Asia/Seoul"
                }
            }
        }
    }
}
```
**Frontend**

```docker
# FE Dockerfile

FROM node:18-alpine AS build

ENV NODE_ENV production

CMD [ "cd", "/front" ]

COPY package.json .

RUN npm cache clean --force

RUN npm install

COPY . .

RUN npm run build

FROM nginx:1.21.3-alpine

COPY nginx.conf /etc/nginx/nginx.conf

COPY --from=build /build /usr/share/nginx/html

EXPOSE 3001

CMD [ "nginx", "-g", "daemon off;" ]

```

```go
// Frontend Jenkinsfile
pipeline {
    agent any
    stages {
        stage("Set Variable") {
            steps {
                script {
                    IMAGE_NAME_FE = "cicdtest-front"
                    CONTAINER_NAME_FE = "cicdtest_front"
                    APPLICATION_ENV_PATH = "/usr/react"
                    PROJECT_DIR_FE = "front"
                }
            }
        }

        // ì„¤ì •íŒŒì¼ ì°¸ì¡°
        stage("copy env") {
            steps {
                sh "cp ${APPLICATION_ENV_PATH}/.env ${PROJECT_DIR_FE}"
            }
        }

        // ì»¨í…Œì´ë„ˆ í´ë¦¬ë‹
        stage("container cleaning") {
            steps{
                sh "docker ps -q -f name=${CONTAINER_NAME_FE} | xargs --no-run-if-empty docker container stop"    
                sh "docker container ls -a -q -f name=${CONTAINER_NAME_FE} | xargs --no-run-if-empty docker rm"
            }
        }

        // ì´ë¯¸ì§€ ì‚­ì œ
        stage("image cleaning") {
            steps{
                sh "docker images ${IMAGE_NAME_FE} -q | xargs -r docker rmi -f"
            }
        }
        
        // ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
        stage("image build") {
            steps {
                dir("${PROJECT_DIR_FE}") {
                    script {
                        sh "docker build --no-cache -t ${IMAGE_NAME_FE} ."
                    }
                }
            }
        }

        // ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        stage("fe container run") {
            steps {
                script {
                    sh "docker run -d -p 3001:3000 --name ${CONTAINER_NAME_FE} ${IMAGE_NAME_FE}"
                }
            }
        }
    }
}

```

### 5. ì™¸ë¶€ API

**KAKAO Login**

[Kakao Developers](https://developers.kakao.com/product/kakaoLogin)

**Naver Login**

[ë„¤ì´ë²„ ë¡œê·¸ì¸ - INTRO](https://developers.naver.com/products/login/api/api.md)

**Google Login**

[ì›¹ ì•±ì— Google ë¡œê·¸ì¸ í†µí•©     Â |Â  Authentication Â |Â  Google for Developers](https://developers.google.com/identity/sign-in/web/sign-in?hl=ko)
